{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}Nova inspeção{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'obras:listar_obras' %}">Obras</a></li>
    <li class="breadcrumb-item"><a href="{% url 'obras:detalhe_obra' obra.id %}">{{ obra.nome }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Nova inspeção</li>
  </ol>
</nav>

<div class="card">
  <div class="card-body">
    <h1 class="h4 mb-3">Nova inspeção - {{ obra }}</h1>
    <form method="post" enctype="multipart/form-data" class="row g-3" id="inspecao-form" data-geo-high-accuracy="false">
      {% csrf_token %}

      {{ form|crispy }}

      <div class="col-12">
        <h2 class="h5 mb-2">Percentuais das tarefas</h2>
        <p class="text-muted mb-3">Ajuste os percentuais das tarefas durante a inspeção.</p>

        <div class="accordion" id="accordionTarefas">
          {% for categoria in categorias %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="cat-heading-{{ categoria.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cat-collapse-{{ categoria.id }}" aria-expanded="false" aria-controls="cat-collapse-{{ categoria.id }}">
                  <div class="w-100 d-flex justify-content-between align-items-center pe-2 gap-2">
                    <span class="fw-semibold">{{ categoria.nome }}</span>
                    <span class="badge bg-primary">{{ categoria.tarefas.all|length }} tarefa(s)</span>
                  </div>
                </button>
              </h2>
              <div id="cat-collapse-{{ categoria.id }}" class="accordion-collapse collapse" aria-labelledby="cat-heading-{{ categoria.id }}" data-bs-parent="#accordionTarefas">
                <div class="accordion-body p-0">
                  {% if categoria.tarefas.all %}
                    <ul class="list-group list-group-flush">
                      {% for tarefa in categoria.tarefas.all|dictsort:"ordem" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-3">
                          <div class="me-2">
                            <div class="fw-semibold">{{ tarefa.nome }}</div>
                            <small class="text-muted">Atual: {{ tarefa.percentual_concluido }}% — Status: {{ tarefa.get_status_display }}</small>
                            {% if user_level == 'nivel1' and tarefa.status == 'concluida' %}
                              <div><small class="text-muted">Tarefa concluída: somente Nível 2/ADM pode alterar.</small></div>
                            {% endif %}
                          </div>

                          <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary text-white">{{ tarefa.percentual_concluido }}%</span>
                            <input
                              type="number"
                              name="task_percent_{{ tarefa.id }}"
                              value="{{ tarefa.percentual_concluido }}"
                              min="0"
                              max="100"
                              step="1"
                              class="form-control form-control-sm"
                              style="width: 90px;"
                              {% if user_level == 'nivel1' and tarefa.status == 'concluida' %}disabled{% endif %}
                            >
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div class="p-3 text-muted">Nenhuma tarefa cadastrada nesta categoria.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% empty %}
            <div class="alert alert-info mb-0">Esta obra ainda não possui categorias/tarefas cadastradas.</div>
          {% endfor %}
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Fotos da inspeção (opcional)</label>
        <input type="file" name="fotos" class="form-control" multiple>
        <small class="text-muted">Você pode selecionar múltiplas imagens.</small>
      </div>

      <input type="hidden" name="latitude" id="id_latitude">
      <input type="hidden" name="longitude" id="id_longitude">
      <input type="hidden" name="location_error_code" id="id_location_error_code">
      <input type="hidden" name="location_error_message" id="id_location_error_message">
      <input type="hidden" name="location_error_reason" id="id_location_error_reason">
      <div class="col-12">
        <div class="border rounded bg-body p-3" id="location-panel">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div class="me-2">
              <div class="fw-semibold">
                <i class="bi bi-geo-alt"></i> Localização
              </div>
              <div class="text-muted small" id="location-status">
                Ao salvar, tentaremos registrar as coordenadas desta inspeção.
              </div>
              <div class="small mt-1 d-none" id="location-coords"></div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button type="button" class="btn btn-sm btn-outline-primary" id="btn-capture-location">
                <span class="spinner-border spinner-border-sm d-none" aria-hidden="true" id="location-spinner"></span>
                <span class="ms-1" id="location-btn-text">Capturar</span>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary d-none" id="btn-clear-location">
                Remover
              </button>
            </div>
          </div>
          <div class="alert alert-warning d-none mt-2 mb-0" role="alert" id="location-alert"></div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">Salvar inspeção</button>
        <a class="btn btn-link text-decoration-none" href="{% url 'obras:detalhe_obra' obra.id %}">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/inspecao_form.js' %}"></script>
{% endblock %}
