{% extends "base.html" %}
{% load l10n %}
{% block title %}Inspeção {{ inspecao.id }}{% endblock %}
{% block extra_head %}
  {{ block.super }}
  {% if inspecao.latitude and inspecao.longitude %}
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      #inspection-map {
        width: 100%;
        min-height: 320px;
        border-radius: var(--bs-border-radius);
      }
      @media (max-width: 576px) {
        #inspection-map {
          min-height: 260px;
        }
      }
    </style>
  {% endif %}
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'obras:listar_obras' %}">Obras</a></li>
    <li class="breadcrumb-item"><a href="{% url 'obras:detalhe_obra' inspecao.obra.id %}">{{ inspecao.obra.nome }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Inspeção #{{ inspecao.id }}</li>
  </ol>
</nav>

<div class="card mb-4">
  <div class="card-body">
    <h1 class="h4 mb-3">Inspeção #{{ inspecao.id }}</h1>
    <div class="row g-3">
      <div class="col-md-6">
        <p><strong>Data:</strong> {{ inspecao.data_inspecao|date:"d/m/Y" }}</p>
        <p><strong>Registrada em:</strong> {{ inspecao.data_hora|date:"d/m/Y H:i" }}</p>
        <p><strong>Usuário:</strong> {{ inspecao.usuario.username }}</p>
      </div>
      {% comment %} <div class="col-md-6">
        <p><strong>Categoria:</strong> {{ inspecao.categoria|default_if_none:"—" }}</p>
        <p><strong>Tarefa:</strong> {{ inspecao.tarefa|default_if_none:"—" }}</p>
      </div> {% endcomment %}
    </div>
    <div class="mt-3">
      <p><strong>Observações:</strong></p>
      <p class="mb-0">{{ inspecao.observacoes_gerais|default:"Sem observações." }}</p>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <span>Alterações de percentuais</span>
    {% if alteracoes_tarefas_count %}
      <span class="badge bg-primary">{{ alteracoes_tarefas_count }} item(ns)</span>
    {% else %}
      <span class="badge bg-secondary">0</span>
    {% endif %}
  </div>
  <div class="card-body {% if alteracoes_tarefas_count %}p-0{% endif %}">
    {% if alteracoes_tarefas_count %}
      <div class="table-responsive">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Categoria</th>
              <th>Tarefa</th>
              <th class="text-end">Antes</th>
              <th class="text-end">Depois</th>
              <th class="text-end">Diferença</th>
            </tr>
          </thead>
          <tbody>
            {% for alt in alteracoes_tarefas %}
              <tr>
                <td>{{ alt.tarefa.categoria.nome }}</td>
                <td>{{ alt.tarefa.nome }}</td>
                <td class="text-end">{{ alt.percentual_antes }}%</td>
                <td class="text-end">{{ alt.percentual_depois }}%</td>
                <td class="text-end">
                  {% if alt.delta > 0 %}
                    <span class="text-success fw-semibold">+{{ alt.delta }}%</span>
                  {% elif alt.delta < 0 %}
                    <span class="text-danger fw-semibold">{{ alt.delta }}%</span>
                  {% else %}
                    <span class="text-muted">0%</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-0 text-muted">Nenhuma tarefa teve o percentual alterado nesta inspeção.</p>
    {% endif %}
  </div>
</div>

{% if inspecao.latitude and inspecao.longitude %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="d-flex flex-column">
      <span>Localização da inspeção</span>
      <small class="text-muted" id="inspection-coords">
        Lat: {{ inspecao.latitude|floatformat:6 }} / Lng: {{ inspecao.longitude|floatformat:6 }}
      </small>
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="Ações de localização">
      <a
        class="btn btn-outline-primary"
        href="https://www.google.com/maps?q={{ inspecao.latitude|unlocalize }},{{ inspecao.longitude|unlocalize }}"
        target="_blank"
        rel="noopener noreferrer"
      >
        <i class="bi bi-geo-alt-fill"></i> Google Maps
      </a>
      <button type="button" class="btn btn-outline-secondary" id="btn-copy-coords">
        <i class="bi bi-clipboard"></i> Copiar
      </button>
    </div>
  </div>
  <div class="card-body">
    <div id="inspection-map"></div>
    <p class="small text-muted mt-2 mb-0">
      Clique no mapa para ativar o zoom do mouse. O marcador indica o ponto registrado.
    </p>
  </div>
</div>
{% endif %}

<div class="card mt-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Fotos da inspeção</span>
  </div>
  <div class="card-body">
    {% if inspecao.fotos.all %}
      <div class="row g-3">
        {% for foto in inspecao.fotos.all %}
          <div class="col-md-4">
            <div class="card h-100">
              <img src="{{ foto.imagem.url }}" class="card-img-top" alt="Foto inspeção {{ forloop.counter }}">
              {% if foto.legenda %}
              <div class="card-body">
                <p class="card-text">{{ foto.legenda }}</p>
              </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="mb-0 text-muted">Nenhuma foto anexada a esta inspeção.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% if inspecao.latitude and inspecao.longitude %}
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin="">
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var lat = parseFloat("{{ inspecao.latitude|unlocalize }}");
        var lng = parseFloat("{{ inspecao.longitude|unlocalize }}");
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        var map = L.map("inspection-map", {
          scrollWheelZoom: false,
          zoomControl: true,
        }).setView([lat, lng], 17);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> colaboradores'
        }).addTo(map);

        L.control.scale({ imperial: false }).addTo(map);

        var popupContent =
          "{{ inspecao.obra.nome|escapejs }}" +
          '<br><small>Lat: ' + lat.toFixed(6) + " / Lng: " + lng.toFixed(6) + "</small>";
        L.marker([lat, lng]).addTo(map).bindPopup(popupContent);

        map.on("click", function () {
          map.scrollWheelZoom.enable();
        });

        var copyBtn = document.getElementById("btn-copy-coords");
        if (copyBtn) {
          copyBtn.addEventListener("click", async function () {
            var text = lat.toFixed(6) + ", " + lng.toFixed(6);
            try {
              await navigator.clipboard.writeText(text);
              copyBtn.blur();
              copyBtn.innerText = "Copiado";
              setTimeout(function () {
                copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copiar';
              }, 1200);
            } catch (e) {
              window.prompt("Copie as coordenadas:", text);
            }
          });
        }

        setTimeout(function () {
          map.invalidateSize();
        }, 100);
      });
    </script>
  {% endif %}
{% endblock %}
