{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Nova Pendencia{% endblock %}

{% block content %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'obras:listar_obras' %}">Obras</a></li>
      <li class="breadcrumb-item"><a href="{% url 'obras:detalhe_obra' obra.id %}">{{ obra.nome }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Nova Pendencia</li>
    </ol>
  </nav>

  <div class="card">
    <div class="card-body">
      <h1 class="h4 mb-3">Nova Pendencia para "{{ obra.nome }}"</h1>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {% if user_level == "nivel1" %}
          <div class="alert alert-light py-2 mb-3">
            <span class="text-muted">Respons√°vel:</span> <strong>{{ user.username }}</strong>
          </div>
        {% endif %}
        {{ form|crispy }}
        <div class="mt-3" id="preview-container">
          <p class="small text-muted mb-1">Preview da imagem</p>
          <img id="preview-imagem" class="img-fluid rounded shadow-sm d-none" alt="Preview da imagem">
        </div>
        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-danger">Salvar Pendencia</button>
          <a href="{% url 'obras:detalhe_obra' obra.id %}" class="btn btn-outline-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const problemaInput = document.getElementById('id_imagem_problema');
  const previewImage = document.getElementById('preview-imagem');
  if (problemaInput && previewImage) {
    problemaInput.addEventListener('change', () => {
      const file = problemaInput.files[0];
      if (file) {
        previewImage.src = URL.createObjectURL(file);
        previewImage.classList.remove('d-none');
      } else {
        previewImage.classList.add('d-none');
      }
    });
  }
</script>
{% endblock %}
