{% extends "base.html" %}
{% block title %}Pendencia {{ pendencia.id }}{% endblock %}

{% block content %}
{% with obra_status=pendencia.obra.status %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'obras:listar_pendencias' %}">Pendencias</a></li>
    <li class="breadcrumb-item active" aria-current="page">Pendencia #{{ pendencia.id }}</li>
  </ol>
</nav>

<div class="card mb-4 shadow-sm">
  <div class="card-header d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <p class="text-muted mb-1 small">Pendencia #{{ pendencia.id }}</p>
      <h1 class="h4 mb-1">{{ pendencia.descricao }}</h1>
      <div class="d-flex gap-2 flex-wrap">
        <span class="badge {% if pendencia.status == 'aberta' %}bg-danger{% elif pendencia.status == 'andamento' %}bg-primary{% else %}bg-success{% endif %}">{{ pendencia.get_status_display }}</span>
        <span class="badge {% if pendencia.prioridade == 'alta' %}bg-danger{% elif pendencia.prioridade == 'media' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ pendencia.get_prioridade_display }}</span>
      </div>
    </div>
    <div class="d-flex gap-2 flex-wrap align-items-center">
      {% if pendencia.status != 'resolvida' and obra_status != 'finalizada' %}
        <form method="post" action="{% url 'obras:atualizar_pendencia' pendencia.id %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="novo_status" value="andamento">
          <button type="submit" class="btn btn-outline-primary btn-sm">Em andamento</button>
        </form>
        <button class="btn btn-success btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#resolverModal">
          Resolver
        </button>
      {% elif pendencia.status == 'resolvida' %}
        <span class="text-success small d-inline-flex align-items-center"><i class="bi bi-check-circle me-1"></i>Resolvida em {{ pendencia.data_fechamento|date:"d/m/Y H:i"|default:"-" }}</span>
      {% elif obra_status == 'finalizada' %}
        <span class="text-muted small d-inline-flex align-items-center"><i class="bi bi-lock me-1"></i>Obra em modo leitura</span>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <p class="mb-1 text-muted">Obra</p>
        <p class="mb-0"><a href="{% url 'obras:detalhe_obra' pendencia.obra.id %}">{{ pendencia.obra.nome }}</a></p>
      </div>
      <div class="col-md-6">
        <p class="mb-1 text-muted">Tarefa</p>
        <p class="mb-0">{{ pendencia.tarefa.nome }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1 text-muted">Responsavel</p>
        <p class="mb-0">{{ pendencia.responsavel|default:"-" }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1 text-muted">Categoria</p>
        <p class="mb-0">{{ pendencia.categoria|default:"-" }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1 text-muted">Data limite</p>
        <p class="mb-0">{{ pendencia.data_limite|date:"d/m/Y"|default:"-" }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1 text-muted">Abertura</p>
        <p class="mb-0">{{ pendencia.data_abertura|date:"d/m/Y H:i" }}</p>
      </div>
    </div>

    <div class="mt-4">
      <p class="mb-1 text-muted">Descricao</p>
      <p class="mb-0">{{ pendencia.descricao }}</p>
    </div>

    <div class="mt-4">
      <div class="row g-3">
        {% if pendencia.imagem_problema %}
          <div class="col-md-6">
            <p class="small text-muted mb-1">Foto do problema</p>
            <a href="{{ pendencia.imagem_problema.url }}" target="_blank" rel="noreferrer">
              <img src="{{ pendencia.imagem_problema.url }}" class="img-fluid rounded shadow-sm" alt="Foto do problema">
            </a>
          </div>
        {% endif %}
        {% if pendencia.imagem_resolucao %}
          <div class="col-md-6">
            <p class="small text-muted mb-1">Imagem da resolucao</p>
            <a href="{{ pendencia.imagem_resolucao.url }}" target="_blank" rel="noreferrer">
              <img src="{{ pendencia.imagem_resolucao.url }}" class="img-fluid rounded shadow-sm" alt="Imagem da resolucao">
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="card-footer d-flex flex-wrap gap-2 justify-content-between">
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'obras:listar_pendencias' %}">Voltar para backlog</a>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'obras:detalhe_obra' pendencia.obra.id %}">Ir para obra relacionada</a>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Solucoes registradas</span>
  </div>
  <div class="card-body">
    {% if pendencia.solucoes.all %}
      <ul class="list-group list-group-flush">
        {% for solucao in pendencia.solucoes.all %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between">
              <div>
                <strong>{{ solucao.usuario|default:"Usuario removido" }}</strong>
                <div class="small text-muted">{{ solucao.data_hora|date:"d/m/Y H:i" }}</div>
              </div>
            </div>
            <p class="mb-0 mt-2">{{ solucao.descricao }}</p>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">Nenhuma solucao registrada ainda.</p>
    {% endif %}
  </div>
</div>

{% if pendencia.status != 'resolvida' and obra_status != 'finalizada' %}
<div class="modal fade" id="resolverModal" tabindex="-1" aria-labelledby="resolverModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'obras:atualizar_pendencia' pendencia.id %}" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="resolverModalLabel">Resolver pendencia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="novo_status" value="resolvida">
          <div class="mb-3">
            <label class="form-label">Solucao</label>
            <textarea name="solucao" class="form-control" rows="3" required></textarea>
            <div class="form-text">Obrigatorio para marcar como resolvida.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Imagem da resolucao</label>
            <input type="file" name="imagem_resolucao" accept="image/jpeg,image/png,image/webp" class="form-control">
            <div class="form-text">Opcional. JPG, PNG ou WEBP ate 5MB.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endwith %}
{% endblock %}

{% block extra_js %}
{% if pendencia.status != 'resolvida' and pendencia.obra.status != 'finalizada' %}
<script>
  const resolverModal = document.getElementById('resolverModal');
  if (resolverModal) {
    resolverModal.addEventListener('shown.bs.modal', () => {
      const textarea = resolverModal.querySelector('textarea');
      if (textarea) { textarea.focus(); }
    });
  }
</script>
{% endif %}
{% endblock %}
