{% extends "base.html" %}
{% load static %}
{% block title %}{{ obra.nome }}{% endblock %}

{% block content %}
{% with obra_status=obra.status %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h1 class="h3 mb-0">{{ obra.nome }}</h1>
    <div class="btn-group">
      <a href="{% url 'obras:relatorio_obra' obra.id %}" target="_blank" class="btn btn-outline-dark">
        <i class="bi bi-printer"></i> Relatório
      </a>
      {% if obra_status != 'finalizada' %}
        {% if can_manage_obra %}
        <a href="{% url 'obras:editar_obra' obra.id %}" class="btn btn-outline-secondary">
          <i class="bi bi-pencil"></i> Editar
        </a>
        {% endif %}
        
        {% if can_manage_obra %}
        <form method="post" action="{% url 'obras:concluir_obra' obra.id %}" onsubmit="return confirm('Marcar obra como conclu??da?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-success">
            <i class="bi bi-check2-circle"></i> Concluir Obra
          </button>
        </form>
        {% endif %}
      {% else %}
        <span class="badge bg-success d-flex align-items-center gap-1">
          <i class="bi bi-check2-circle"></i> Concluída
        </span>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    {% if obra_status == 'finalizada' %}
    <div class="alert alert-warning d-flex align-items-center gap-2 mb-4" role="status">
      <i class="bi bi-lock-fill"></i>
      <span>Esta obra esta concluida e em modo somente leitura.</span>
    </div>
    {% endif %}
    {% if user_level == 'nivel1' and obra_status != 'finalizada' %}
    <div class="alert alert-info d-flex align-items-center gap-2 mb-4" role="status">
      <i class="bi bi-info-circle"></i>
      <span>Ao concluir uma tarefa, somente um usuário Nível 2 pode reabri-la para ajustes.</span>
    </div>
    {% endif %}
    <div class="row g-3">
      <div class="col-md-6">
        <p><strong>Status:</strong> {{ obra.get_status_display }}</p>
        <p><strong>Cliente:</strong> {{ obra.cliente|default:"—" }}</p>
        <p><strong>Endereço:</strong> {{ obra.endereco|default:"—" }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Prazo final:</strong> {{ obra.data_fim_prevista|date:"d/m/Y" }}</p>
        <div>
          <strong>Conclusão Geral:</strong>
          <div class="progress mt-1" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated d-flex align-items-center justify-content-center fw-semibold" role="progressbar" style="width: {{ percentual_concluido }}%;" aria-valuenow="{{ percentual_concluido }}" aria-valuemin="0" aria-valuemax="100">
              {{ percentual_concluido }}%
            </div>
          </div>
        </div>
      </div>
      {% if obra.capa %}
      <div class="col-12">
        <p class="mb-1"><strong>Foto da obra:</strong></p>
        <img src="{{ obra.capa.url }}" alt="Capa da obra" class="img-fluid rounded shadow-sm" style="max-height: 260px; object-fit: cover;">
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted mb-1">Tarefas</p>
        <h4 class="mb-0">{{ stats_resumo.total }}</h4>
        <small>Total cadastradas</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted mb-1">Concluídas</p>
        <h4 class="mb-0 text-success">{{ stats_resumo.concluidas }}</h4>
        <small>Entregues</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted mb-1">Bloqueadas</p>
        <h4 class="mb-0 text-warning">{{ stats_resumo.atrasadas }}</h4>
        <small>Atenção</small>
      </div>
    </div>
  </div>
</div>


<div class="card mb-4" id="pendencias">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <p class="text-muted mb-1">Pendências da obra</p>
      <h3 class="h5 mb-0">Pendências</h3>
    </div>
    {% if obra_status != 'finalizada' and can_manage_pendencias %}
      <a class="btn btn-sm btn-outline-danger" href="{% url 'obras:nova_pendencia' obra.id %}"><i class="bi bi-plus-circle"></i> Nova pendência</a>
    {% elif obra_status != 'finalizada' %}
      <span class="badge bg-light text-muted">Permissão restrita</span>
    {% else %}
      <span class="badge bg-light text-muted">Modo somente leitura</span>
    {% endif %}

 </div>
  <div class="card-body">
    <ul class="nav nav-pills mb-3">
      <li class="nav-item">
        <a class="nav-link {% if pendencias_status == 'aberta' %}active{% endif %}" href="?pend_status=aberta#pendencias">Abertas ({{ abertas_count }})</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if pendencias_status == 'andamento' %}active{% endif %}" href="?pend_status=andamento#pendencias">Em andamento ({{ andamento_count }})</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if pendencias_status == 'resolvida' %}active{% endif %}" href="?pend_status=resolvida#pendencias">Resolvidas ({{ resolvidas_count }})</a>
      </li>
    </ul>

    {% if pendencias %}
      <div class="table-responsive">
        <table class="table align-middle table-hover">
          <thead class="table-light">
            <tr>
              <th scope="col">Pendência</th>
              <th scope="col" class="text-center">Status</th>
              <th scope="col">Prazos</th>
              <th scope="col" class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for pendencia in pendencias %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ pendencia.descricao }}</div>
                  <div class="small text-muted">
                    {{ pendencia.tarefa.nome }} {% if pendencia.categoria %}- {{ pendencia.categoria.nome }}{% endif %}
                  </div>
                  {% if pendencia.responsavel %}
                    <div class="small text-muted">Responsável: {{ pendencia.responsavel }}</div>
                  {% endif %}
                  <div class="mt-1">
                    <span class="badge {% if pendencia.prioridade == 'alta' %}bg-danger{% elif pendencia.prioridade == 'media' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">Prioridade {{ pendencia.get_prioridade_display }}</span>
                  </div>
                  {% if pendencia.status == 'resolvida' %}
                    <div class="small mt-1">
                      {% if pendencia.imagem_resolucao %}
                        <a class="link-success" href="{{ pendencia.imagem_resolucao.url }}" target="_blank" rel="noreferrer">Imagem da solucao</a>
                      {% else %}
                        <span class="text-muted">Sem imagem de solucao</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </td>
                <td class="text-center">
                  <span class="badge {% if pendencia.status == 'resolvida' %}bg-success{% elif pendencia.status == 'andamento' %}bg-primary{% else %}bg-danger{% endif %}">{{ pendencia.get_status_display }}</span>
                </td>
                <td class="small">
                  <div class="text-muted">Abertura: {{ pendencia.data_abertura|date:"d/m/Y H:i" }}</div>
                  <div class="text-muted">Limite: {{ pendencia.data_limite|date:"d/m/Y"|default:"Sem prazo" }}</div>
                  {% if pendencia.data_fechamento %}
                    <div class="text-success">Fechamento: {{ pendencia.data_fechamento|date:"d/m/Y H:i" }}</div>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="d-flex justify-content-end flex-wrap gap-2">
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'obras:detalhe_pendencia' pendencia.id %}">Ver detalhes</a>
                    {% if pendencia.status != 'resolvida' and obra_status != 'finalizada' %}
                      {% if pendencia.status != 'andamento' %}
                        <form method="post" action="{% url 'obras:atualizar_pendencia' pendencia.id %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="novo_status" value="andamento">
                          <input type="hidden" name="next" value="{{ pendencias_redirect }}#pendencias">
                          <button type="submit" class="btn btn-sm btn-outline-primary">Em andamento</button>
                        </form>
                      {% endif %}
                      <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#resolverPendenciaModal" data-update-url="{% url 'obras:atualizar_pendencia' pendencia.id %}" data-descricao="{{ pendencia.descricao|escapejs }}">
                        Resolver
                      </button>
                    {% elif pendencia.status == 'resolvida' %}
                      <span class="text-success small d-flex align-items-center"><i class="bi bi-check-circle me-1"></i> Resolvida</span>
                    {% elif obra_status == 'finalizada' %}
                      <span class="text-muted small d-flex align-items-center"><i class="bi bi-lock me-1"></i> Somente leitura</span>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-0 text-muted">Nenhuma pendência encontrada neste filtro.</p>
    {% endif %}
  </div>
</div>

<div class="card mb-4" id="inspecoes">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <p class="text-muted mb-1">Inspeções registradas</p>
      <h3 class="h5 mb-0">Inspeções ({{ inspecoes_total }})</h3>
    </div>
    <div class="d-flex gap-2">
      {% if obra_status != 'finalizada' and can_add_inspecao %}
        <a class="btn btn-sm btn-success" href="{% url 'inspecoes:nova_inspecao' obra.id %}"><i class="bi bi-clipboard-plus"></i> Nova inspeção</a>
      {% endif %}
      <a class="btn btn-sm btn-outline-primary" href="{% url 'inspecoes:lista_obra' obra.id %}"><i class="bi bi-geo-alt"></i> Ver no mapa</a>
    </div>
  </div>
  <div class="card-body">
    {% if inspecoes_page.object_list %}
      <div class="table-responsive mb-3">
        <table class="table align-middle table-hover">
          <thead class="table-light">
            <tr>
              <th scope="col">Data</th>
              <th scope="col">Usuário</th>
              <th scope="col">Categoria / Tarefa</th>
              <th scope="col">Coordenadas</th>
              <th scope="col" class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for insp in inspecoes_page %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ insp.data_inspecao|date:"d/m/Y" }}</div>
                  <div class="text-muted small">{{ insp.data_hora|date:"H:i" }}</div>
                </td>
                <td>{{ insp.usuario.username }}</td>
                <td class="small">
                  {{ insp.categoria|default_if_none:"Sem categoria" }}<br>
                  {{ insp.tarefa|default_if_none:"Sem tarefa" }}
                </td>
                <td>
                  {% if insp.latitude and insp.longitude %}
                    <span class="badge bg-light text-dark">
                      <i class="bi bi-geo-alt-fill"></i>
                      {{ insp.latitude|floatformat:6 }}, {{ insp.longitude|floatformat:6 }}
                    </span>
                  {% else %}
                    <span class="text-muted small">Sem coordenadas</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'inspecoes:detalhe_inspecao' insp.id %}">Ver detalhes</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav aria-label="Paginação das inspeções">
        <ul class="pagination justify-content-end mb-0">
          <li class="page-item {% if not inspecoes_page.has_previous %}disabled{% endif %}">
            <a class="page-link" href="{% if inspecoes_page.has_previous %}?insp_page={{ inspecoes_page.previous_page_number }}{% if pendencias_status %}&pend_status={{ pendencias_status }}{% endif %}#inspecoes{% else %}#{% endif %}">Anterior</a>
          </li>
          <li class="page-item disabled">
            <span class="page-link">Página {{ inspecoes_page.number }} de {{ inspecoes_page.paginator.num_pages }}</span>
          </li>
          <li class="page-item {% if not inspecoes_page.has_next %}disabled{% endif %}">
            <a class="page-link" href="{% if inspecoes_page.has_next %}?insp_page={{ inspecoes_page.next_page_number }}{% if pendencias_status %}&pend_status={{ pendencias_status }}{% endif %}#inspecoes{% else %}#{% endif %}">Próxima</a>
          </li>
        </ul>
      </nav>
    {% else %}
      <p class="mb-0 text-muted">Nenhuma inspeção registrada ainda.</p>
    {% endif %}
  </div>
</div>


{% if obra_status != 'finalizada' %}
<div class="modal fade" id="resolverPendenciaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content" id="resolverPendenciaForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="novo_status" value="resolvida">
      <input type="hidden" name="next" value="{{ pendencias_redirect }}#pendencias">
      <div class="modal-header">
        <h5 class="modal-title">Resolver pendência</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted mb-2" id="resolverPendenciaDescricao"></p>
        <div class="mb-3">
          <label class="form-label" for="resolverPendenciaSolucao">Solução adotada</label>
          <textarea class="form-control" name="solucao" id="resolverPendenciaSolucao" rows="3" required></textarea>
          <div class="form-text">Obrigatório para concluir a pendência.</div>
        </div>
        <div class="mb-3">
          <label class="form-label" for="resolverPendenciaImagem">Imagem da solucao (opcional)</label>
          <input class="form-control" type="file" id="resolverPendenciaImagem" name="imagem_resolucao" accept="image/jpg,image/jpeg,image/png,image/webp">
          <div class="form-text">JPG, PNG ou WEBP ate 5MB.</div>
          <div class="mt-2">
            <img id="resolverPendenciaPreview" class="img-fluid rounded shadow-sm d-none" alt="Preview da imagem da solucao" style="max-height: 220px; object-fit: cover;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success">Marcar como resolvida</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Categorias e Tarefas</h3>
  {% if obra_status != 'finalizada' and can_manage_structure %}
    <a href="{% url 'obras:nova_categoria' obra.id %}" class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle"></i> Adicionar Categoria
    </a>
  {% endif %}
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Anexos</span>
    {% if obra_status != 'finalizada' and can_add_anexo %}
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'obras:novo_anexo' obra.id %}"><i class="bi bi-paperclip"></i> Novo anexo</a>
    {% endif %}
  </div>
  <div class="card-body">
    {% if anexos %}
      <ul class="list-group list-group-flush">
        {% for anexo in anexos %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-paperclip me-2"></i>
              <a href="{{ anexo.arquivo.url }}" target="_blank">{{ anexo.descricao|default:anexo.arquivo.name }}</a>
              {% if anexo.categoria %}<span class="badge bg-light text-dark ms-2">{{ anexo.categoria.nome }}</span>{% endif %}
              <small class="d-block text-muted">Enviado por {{ anexo.enviado_por|default:'N/A' }} em {{ anexo.enviado_em|date:"d/m/Y H:i" }}</small>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">Nenhum anexo ainda.</p>
    {% endif %}
  </div>
</div>

<div class="accordion" id="accordionCategorias">
  {% for categoria in categorias %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-{{ categoria.id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ categoria.id }}" aria-expanded="false" aria-controls="collapse-{{ categoria.id }}">
          <div class="w-100 d-flex justify-content-between align-items-center pe-2 gap-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="fw-bold me-2">{{ categoria.nome }}</span>
              <span class="badge rounded-pill bg-primary">{{ categoria.tarefas.all|length }} tarefa(s)</span>
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
              <div class="progress category-progress" data-category-id="{{ categoria.id }}" style="width: 200px; height: 15px;">
                <div class="progress-bar d-flex align-items-center justify-content-center" role="progressbar" style="width: {{ categoria.percentual_concluido }}%;" aria-valuenow="{{ categoria.percentual_concluido }}" aria-valuemin="0" aria-valuemax="100" >
                  <span class="progress-label">{{ categoria.percentual_concluido }}%</span>
                </div>
              </div>
              {% if obra_status != 'finalizada' and can_manage_structure %}
                <div class="btn-group" role="group" aria-label="Ações da categoria">
                  <a href="{% url 'obras:editar_categoria' categoria.id %}"
                     class="btn btn-sm btn-outline-secondary py-0 px-1"
                     onclick="event.stopPropagation();">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <a href="{% url 'obras:excluir_categoria' categoria.id %}"
                     class="btn btn-sm btn-outline-danger py-0 px-1"
                     onclick="event.stopPropagation();">
                    <i class="bi bi-trash"></i>
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        </button>
      </h2>
      <div id="collapse-{{ categoria.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ categoria.id }}" data-bs-parent="#accordionCategorias">
        <div class="accordion-body p-0">
          {% if categoria.tarefas.all %}
            <ul class="list-group list-group-flush">
              {% for tarefa in categoria.tarefas.all|dictsort:"ordem" %}
              <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                <div class="me-3">
                  {% if obra_status != 'finalizada' and can_manage_structure %}
                  <a href="{% url 'obras:editar_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-secondary me-2 py-0 px-1">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <a href="{% url 'obras:excluir_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-danger me-2 py-0 px-1">
                    <i class="bi bi-trash"></i>
                  </a>
                  {% endif %}
                  <strong>{{ tarefa.nome }}</strong> -
                  {% if obra_status != 'finalizada' and can_update_task_progress %}
                  <span class="badge bg-info text-dark task-progress"
                        data-task-id="{{ tarefa.id }}"
                        data-category-id="{{ categoria.id }}"
                        data-can-edit="true"
                        data-lock-level1="{% if tarefa.status == 'concluida' %}true{% else %}false{% endif %}"
                        data-lock-message="{{ nivel1_lock_message }}"
                        style="cursor: pointer;" title="Clique para editar">
                    {{ tarefa.percentual_concluido }}%</span>
                  {% else %}
                  <span class="badge bg-secondary text-white">
                    {{ tarefa.percentual_concluido }}%</span>
                  {% endif %}
                </div>
                  <div class="d-flex align-items-center" id="task-status-wrapper-{{ tarefa.id }}">
                    {% if tarefa.status == 'concluida' %}
                      <span class="badge bg-success me-3">Concluída</span>
                    {% elif tarefa.status == 'andamento' %}
                      <span class="badge bg-primary me-3">Em andamento</span>
                    {% elif tarefa.status == 'bloqueada' %}
                      <span class="badge bg-warning text-dark me-3">Bloqueada</span>
                    {% else %}
                      <span class="badge bg-secondary me-3">Não iniciada</span>
                    {% endif %}
                    <small class="text-muted" id="task-date-wrapper-{{ tarefa.id }}">
                      {% if tarefa.data_fim_real %}
                        <strong>Concluído em: {{ tarefa.data_fim_real|date:"d/m/Y" }}</strong>
                      {% else %}
                        Previsto: {{ tarefa.data_fim_prevista|date:"d/m/Y" }}
                      {% endif %}
                    </small>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="p-3 mb-0 text-muted">Nenhuma tarefa cadastrada nesta categoria.</p>
          {% endif %}
          {% if obra_status != 'finalizada' and can_manage_structure %}
          <div class="card-footer bg-light p-2 text-end">
            <a href="{% url 'obras:nova_tarefa' categoria.id %}" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus"></i> Adicionar Tarefa
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">Esta obra ainda não possui categorias cadastradas.</div>
  {% endfor %}
</div>
{% endwith %}
{% endblock %}

{% block extra_js %}
{% if obra.status != 'finalizada' %}
<script>
  window.updateTaskProgressUrl = "{% url 'obras:update_task_progress' %}";
  const resolverPendenciaModal = document.getElementById('resolverPendenciaModal');
  if (resolverPendenciaModal) {
    resolverPendenciaModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const updateUrl = button ? button.getAttribute('data-update-url') : null;
      const descricao = button ? button.getAttribute('data-descricao') : '';
      const form = document.getElementById('resolverPendenciaForm');
      const descEl = document.getElementById('resolverPendenciaDescricao');
      if (form && updateUrl) {
        form.action = updateUrl;
      }
      if (descEl) {
        descEl.textContent = descricao || '';
      }
      if (form) {
        const textarea = form.querySelector('textarea[name="solucao"]');
        if (textarea) {
          textarea.value = '';
          setTimeout(() => textarea.focus(), 100);
        }

        const previewEl = document.getElementById('resolverPendenciaPreview');
        const fileInput = form.querySelector('input[name="imagem_resolucao"]');
        if (fileInput) {
          fileInput.value = '';
          if (!fileInput.dataset.previewBound) {
            fileInput.dataset.previewBound = '1';
            fileInput.addEventListener('change', () => {
              const file = fileInput.files && fileInput.files[0];
              if (!previewEl) return;
              if (file) {
                previewEl.src = URL.createObjectURL(file);
                previewEl.classList.remove('d-none');
              } else {
                previewEl.src = '';
                previewEl.classList.add('d-none');
              }
            });
          }
        }
        if (previewEl) {
          previewEl.src = '';
          previewEl.classList.add('d-none');
        }
      }
    });
  }
</script>
<script src="{% static 'js/obras.js' %}"></script>
{% endif %}
{% endblock %}
