{% extends "base.html" %}
{% block title %}{{ obra.nome }}{% endblock %}

{% block content %}
<!-- Card principal com informações da obra e ações -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
    <h1 class="h3 mb-0">{{ obra.nome }}</h1>
    <div class="btn-group mt-2 mt-md-0">
      <a href="{% url 'obras:editar_obra' obra.id %}" class="btn btn-outline-secondary">
        <i class="bi bi-pencil"></i> Editar
      </a>
      <a href="{% url 'obras:nova_pendencia' obra.id %}" class="btn btn-outline-danger">
        <i class="bi bi-exclamation-triangle"></i> Nova Pendência
      </a>
      <a href="{% url 'inspecoes:nova_inspecao' obra.id %}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Registrar Inspeção
      </a>
      <a href="{% url 'inspecoes:lista_obra' obra.id %}" class="btn btn-outline-primary">
        <i class="bi bi-map"></i> Ver no Mapa
      </a>
    </div>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <p><strong>Cliente:</strong> {{ obra.cliente }}</p>
        <p><strong>Endereço:</strong> {{ obra.endereco }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Prazo final:</strong> {{ obra.data_fim_prevista|date:"d/m/Y" }}</p>
        <div>
          <strong>Conclusão Geral:</strong>
          <div class="progress mt-1" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{ percentual_concluido }}%;" aria-valuenow="{{ percentual_concluido }}" aria-valuemin="0" aria-valuemax="100">
              {{ percentual_concluido }}%
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Categorias e Tarefas</h3>
  <a href="{% url 'obras:nova_categoria' obra.id %}" class="btn btn-sm btn-primary">
    <i class="bi bi-plus-circle"></i> Adicionar Categoria
  </a>
</div>

<!-- Acordeão para as categorias -->
<div class="accordion" id="accordionCategorias">
  {% for categoria in categorias %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-{{ categoria.id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ categoria.id }}" aria-expanded="false" aria-controls="collapse-{{ categoria.id }}">
          <div class="w-100 d-flex justify-content-between align-items-center pe-2">
            <div>
              <span class="fw-bold me-2">{{ categoria.nome }}</span>
              <span class="badge rounded-pill bg-primary">{{ categoria.tarefas.all|length }} tarefa(s)</span>
            </div>
            <div class="progress category-progress" data-category-id="{{ categoria.id }}" style="width: 200px; height: 15px;">
              <div class="progress-bar" role="progressbar" style="width: {{ categoria.percentual_concluido }}%;" aria-valuenow="{{ categoria.percentual_concluido }}" aria-valuemin="0" aria-valuemax="100" >
                <small>{{ categoria.percentual_concluido }}%</small>
              </div>
            </div>
          </div>
        </button>
      </h2>
      <div id="collapse-{{ categoria.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ categoria.id }}" data-bs-parent="#accordionCategorias">
        <div class="accordion-body p-0">
          {% if categoria.tarefas.all %}
            <ul class="list-group list-group-flush">
              {% for tarefa in categoria.tarefas.all|dictsort:"ordem" %}
                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                  <div class="me-3">
                    <a href="{% url 'obras:editar_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-secondary me-2 py-0 px-1">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <strong>{{ tarefa.nome }}</strong> - 
                    <span class="badge bg-info text-dark task-progress" data-task-id="{{ tarefa.id }}" data-category-id="{{ categoria.id }}" style="cursor: pointer;" title="Clique para editar">
                      {{ tarefa.percentual_concluido }}%</span>
                  </div>
                  <div class="d-flex align-items-center" id="task-status-wrapper-{{ tarefa.id }}">
                    {% if tarefa.status == 'concluida' %}
                      <span class="badge bg-success me-3">Concluída</span>
                    {% elif tarefa.status == 'andamento' %}
                      <span class="badge bg-primary me-3">Em andamento</span>
                    {% elif tarefa.status == 'pendente' %}<span class="badge bg-warning text-dark me-3">Pendente</span>
                    {% else %}<span class="badge bg-secondary me-3">Não Iniciada</span>
                    {% endif %}
                    <small class="text-muted">Previsto: {{ tarefa.data_fim_prevista|date:"d/m/Y" }}</small>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="p-3 mb-0 text-muted">Nenhuma tarefa cadastrada nesta categoria.</p>
          {% endif %}
          <div class="card-footer bg-light p-2 text-end">
            <a href="{% url 'obras:nova_tarefa' categoria.id %}" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus"></i> Adicionar Tarefa
            </a>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">Esta obra ainda não possui categorias cadastradas.</div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Função para obter o token CSRF dos cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const progressSpans = document.querySelectorAll('.task-progress');

    progressSpans.forEach(span => {
        span.addEventListener('click', function () {
            const currentProgress = this.textContent.replace('%', '');
            const taskId = this.dataset.taskId;
            const categoryId = this.dataset.categoryId;

            // Cria um input do tipo range (slider)
            const input = document.createElement('input');
            input.type = 'range';
            input.min = 0;
            input.max = 100;
            input.value = currentProgress;
            input.classList.add('form-range');
            input.style.width = '100px';

            // Substitui o span pelo input
            this.style.display = 'none';
            this.parentNode.insertBefore(input, this.nextSibling);
            input.focus();

            // Evento para quando o valor do slider for alterado
            const handleUpdate = function() {
                const newProgress = input.value;

                // Se for 100%, pede confirmação
                if (newProgress == 100) {
                    if (!confirm("Você confirma a finalização desta tarefa? A data de conclusão será registrada.")) {
                        // Se o usuário cancelar, restaura a UI e não faz nada
                        input.parentNode.removeChild(input);
                        span.style.display = 'inline-block';
                        return;
                    }
                }

                fetch("{% url 'obras:update_task_progress' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ task_id: taskId, progress: newProgress })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Atualiza o texto do span e o exibe novamente
                        span.textContent = newProgress + '%';
                        
                        // Atualiza a barra de progresso da categoria
                        const categoryProgressDiv = document.querySelector(`.category-progress[data-category-id="${categoryId}"] .progress-bar`);
                        categoryProgressDiv.style.width = data.new_category_progress + '%';
                        categoryProgressDiv.querySelector('small').textContent = data.new_category_progress + '%';

                        // Atualiza o badge de status da tarefa
                        const statusWrapper = document.getElementById(`task-status-wrapper-${taskId}`);
                        const statusBadge = statusWrapper.querySelector('.badge');
                        statusBadge.textContent = data.task_status_display;

                        // Remove classes de cor antigas e adiciona a nova
                        statusBadge.classList.remove('bg-success', 'bg-primary', 'bg-warning', 'bg-secondary');
                        if (data.task_status === 'concluida') {
                            statusBadge.classList.add('bg-success');
                        } else if (data.task_status === 'andamento') {
                            statusBadge.classList.add('bg-primary');
                        } else {
                            statusBadge.classList.add('bg-secondary');
                        }

                    }
                })
                .finally(() => {
                    // Remove o input e mostra o span novamente
                    input.parentNode.removeChild(input);
                    span.style.display = 'inline-block';
                });
            };

            input.addEventListener('change', handleUpdate);
            input.addEventListener('blur', handleUpdate);
        });
    });
});
</script>
{% endblock %}
