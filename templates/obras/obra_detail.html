{% extends "base.html" %}
{% load static %}
{% block title %}{{ obra.nome }}{% endblock %}

{% block content %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h1 class="h3 mb-0">{{ obra.nome }}</h1>
    <div class="btn-group">
      <a href="{% url 'obras:editar_obra' obra.id %}" class="btn btn-outline-secondary">
        <i class="bi bi-pencil"></i> Editar
      </a>
      <a href="{% url 'obras:nova_pendencia' obra.id %}" class="btn btn-outline-danger">
        <i class="bi bi-exclamation-triangle"></i> Nova Pendência
      </a>
      <a href="{% url 'inspecoes:nova_inspecao' obra.id %}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Registrar Inspeção
      </a>
      <a href="{% url 'inspecoes:lista_obra' obra.id %}" class="btn btn-outline-primary">
        <i class="bi bi-map"></i> Ver no Mapa
      </a>
      {% if obra.status != 'finalizada' %}
      <form method="post" action="{% url 'obras:concluir_obra' obra.id %}" onsubmit="return confirm('Marcar obra como concluída?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-success">
          <i class="bi bi-check2-circle"></i> Concluir Obra
        </button>
      </form>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <p><strong>Status:</strong> {{ obra.get_status_display }}</p>
        <p><strong>Cliente:</strong> {{ obra.cliente }}</p>
        <p><strong>Endereço:</strong> {{ obra.endereco }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Prazo final:</strong> {{ obra.data_fim_prevista|date:"d/m/Y" }}</p>
        <p><strong>Custo previsto:</strong> {{ obra.custo_previsto|default:"—" }}</p>
        <p><strong>Custo real:</strong> {{ obra.custo_real|default:"—" }}</p>
        <div>
          <strong>Conclusão Geral:</strong>
          <div class="progress mt-1" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated d-flex align-items-center justify-content-center fw-semibold" role="progressbar" style="width: {{ percentual_concluido }}%;" aria-valuenow="{{ percentual_concluido }}" aria-valuemin="0" aria-valuemax="100">
              {{ percentual_concluido }}%
            </div>
          </div>
        </div>
      </div>
      {% if obra.capa %}
      <div class="col-12">
        <p class="mb-1"><strong>Foto da obra:</strong></p>
        <img src="{{ obra.capa.url }}" alt="Capa da obra" class="img-fluid rounded shadow-sm" style="max-height: 260px; object-fit: cover;">
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted mb-1">Tarefas</p>
        <h4 class="mb-0">{{ stats_resumo.total }}</h4>
        <small>Total cadastradas</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted mb-1">Concluídas</p>
        <h4 class="mb-0 text-success">{{ stats_resumo.concluidas }}</h4>
        <small>Entregues</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted mb-1">Bloqueadas</p>
        <h4 class="mb-0 text-warning">{{ stats_resumo.atrasadas }}</h4>
        <small>Atenção</small>
      </div>
    </div>
  </div>
</div>

{% if grafico_progresso.dias_totais %}
{% endif %}

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Inspeções recentes (até 5)</span>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-success" href="{% url 'inspecoes:nova_inspecao' obra.id %}"><i class="bi bi-clipboard-plus"></i> Nova inspeção</a>
      <a class="btn btn-sm btn-outline-primary" href="{% url 'inspecoes:lista_obra' obra.id %}"><i class="bi bi-geo-alt"></i> Ver todas</a>
    </div>
  </div>
  <div class="card-body">
    {% if inspecoes_recentes %}
      <ul class="list-group list-group-flush">
        {% for insp in inspecoes_recentes %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <a href="{% url 'inspecoes:detalhe_inspecao' insp.id %}" class="fw-semibold text-decoration-none">
                {{ insp.data_inspecao|date:"d/m/Y" }} - {{ insp.usuario.username }}
              </a>
              <div class="small text-muted">
                {{ insp.categoria|default_if_none:"Sem categoria" }} / {{ insp.tarefa|default_if_none:"Sem tarefa" }}
              </div>
            </div>
            {% if insp.latitude and insp.longitude %}
              <span class="badge bg-light text-dark"><i class="bi bi-geo-alt"></i> {{ insp.latitude }}, {{ insp.longitude }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">Nenhuma inspeção registrada ainda.</p>
    {% endif %}
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Categorias e Tarefas</h3>
  <a href="{% url 'obras:nova_categoria' obra.id %}" class="btn btn-sm btn-primary">
    <i class="bi bi-plus-circle"></i> Adicionar Categoria
  </a>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Anexos</span>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'obras:novo_anexo' obra.id %}"><i class="bi bi-paperclip"></i> Novo anexo</a>
  </div>
  <div class="card-body">
    {% if anexos %}
      <ul class="list-group list-group-flush">
        {% for anexo in anexos %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-paperclip me-2"></i>
              <a href="{{ anexo.arquivo.url }}" target="_blank">{{ anexo.descricao|default:anexo.arquivo.name }}</a>
              {% if anexo.categoria %}<span class="badge bg-light text-dark ms-2">{{ anexo.categoria.nome }}</span>{% endif %}
              <small class="d-block text-muted">Enviado por {{ anexo.enviado_por|default:'N/A' }} em {{ anexo.enviado_em|date:"d/m/Y H:i" }}</small>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">Nenhum anexo ainda.</p>
    {% endif %}
  </div>
</div>

<div class="accordion" id="accordionCategorias">
  {% for categoria in categorias %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-{{ categoria.id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ categoria.id }}" aria-expanded="false" aria-controls="collapse-{{ categoria.id }}">
          <div class="w-100 d-flex justify-content-between align-items-center pe-2">
            <div>
              <span class="fw-bold me-2">{{ categoria.nome }}</span>
              <span class="badge rounded-pill bg-primary">{{ categoria.tarefas.all|length }} tarefa(s)</span>
            </div>
            <div class="progress category-progress" data-category-id="{{ categoria.id }}" style="width: 200px; height: 15px;">
              <div class="progress-bar d-flex align-items-center justify-content-center" role="progressbar" style="width: {{ categoria.percentual_concluido }}%;" aria-valuenow="{{ categoria.percentual_concluido }}" aria-valuemin="0" aria-valuemax="100" >
                <span class="progress-label">{{ categoria.percentual_concluido }}%</span>
              </div>
            </div>
          </div>
        </button>
      </h2>
      <div id="collapse-{{ categoria.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ categoria.id }}" data-bs-parent="#accordionCategorias">
        <div class="accordion-body p-0">
          {% if categoria.tarefas.all %}
            <ul class="list-group list-group-flush">
              {% for tarefa in categoria.tarefas.all|dictsort:"ordem" %}
                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                  <div class="me-3">
                    <a href="{% url 'obras:editar_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-secondary me-2 py-0 px-1">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <strong>{{ tarefa.nome }}</strong> -
                    <span class="badge bg-info text-dark task-progress" data-task-id="{{ tarefa.id }}" data-category-id="{{ categoria.id }}" style="cursor: pointer;" title="Clique para editar">
                      {{ tarefa.percentual_concluido }}%</span>
                  </div>
                  <div class="d-flex align-items-center" id="task-status-wrapper-{{ tarefa.id }}">
                    {% if tarefa.status == 'concluida' %}
                      <span class="badge bg-success me-3">Concluída</span>
                    {% elif tarefa.status == 'andamento' %}
                      <span class="badge bg-primary me-3">Em andamento</span>
                    {% elif tarefa.status == 'bloqueada' %}
                      <span class="badge bg-warning text-dark me-3">Bloqueada</span>
                    {% else %}
                      <span class="badge bg-secondary me-3">Não iniciada</span>
                    {% endif %}
                    <small class="text-muted" id="task-date-wrapper-{{ tarefa.id }}">
                      {% if tarefa.data_fim_real %}
                        <strong>Concluído em: {{ tarefa.data_fim_real|date:"d/m/Y" }}</strong>
                      {% else %}
                        Previsto: {{ tarefa.data_fim_prevista|date:"d/m/Y" }}
                      {% endif %}
                    </small>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="p-3 mb-0 text-muted">Nenhuma tarefa cadastrada nesta categoria.</p>
          {% endif %}
          <div class="card-footer bg-light p-2 text-end">
            <a href="{% url 'obras:nova_tarefa' categoria.id %}" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus"></i> Adicionar Tarefa
            </a>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">Esta obra ainda não possui categorias cadastradas.</div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.updateTaskProgressUrl = "{% url 'obras:update_task_progress' %}";
</script>
<script src="{% static 'js/obras.js' %}"></script>
{% endblock %}
