Mapeamento

PB-01 — Barra: Progresso por obra na visão geral

Onde aparece: rota obras:visao_geral (/obras/visao-geral/), tabela de obras em templates/obras/visao_geral.html (line 101).
Fonte do valor: loop em ObraOverviewView.get_context_data (obras/views.py (lines 112-145)).
Base de cálculo: perc_concluido = round((tarefas_concluidas / total_tarefas) * 100, 1); se não houver tarefas o valor é 0.
Dependências: Tarefa (status, categoria_id → Obra), Obra (data_inicio, data_fim_prevista apenas para gráficos).
Observações: executa uma aggregate por obra (N+1) apesar do prefetch_related; ignora progresso parcial (só contas tarefas 100%) e pode divergir dos cards em /obras/; o mesmo número é usado no gráfico de linhas (templates/obras/visao_geral.html (line 51), chart_lines).

PB-02 — Barra: “Progresso real” nas cards de obra

Onde aparece: rota obras:listar_obras (/obras/), cards em templates/obras/obra_list.html (lines 78-91).
Fonte do valor: ObraListView.get_context_data (obras/views.py (lines 69-94)) consome get_obras_progress_snapshot (obras/services.py (lines 91-154)).
Base de cálculo: usa Avg(percentual_concluido) das tarefas sempre que existir alguma tarefa com percentual entre 0 e 100; caso contrário volta para concluidas/total * 100; resultado é round(_clamp_percentage(...), 1).
Dependências: Tarefa.percentual_concluido, Tarefa.status, Obra.data_inicio, Obra.data_fim_prevista (para esperados/delta).
Observações: é a única barra que reflete progresso parcial, portanto pode mostrar números bem diferentes das demais telas; o serviço clampa 0..100 corretamente e evita N+1.

PB-03 — Barra: “Progresso esperado” nas cards

Onde aparece: mesma rota /obras/, progress bar secundária em templates/obras/obra_list.html (lines 94-107).
Fonte do valor: calculate_expected_progress (obras/services.py (lines 69-89)) chamado dentro de get_obras_progress_snapshot.
Base de cálculo: (dias_passados / dias_totais) * 100 considerando data_inicio e data_fim_prevista; valores antes do início retornam 0, após o fim retornam 100, e o helper clampa 0..100.
Dependências: Obra.data_inicio, Obra.data_fim_prevista.
Observações: se qualquer data estiver ausente retorna None e a barra some; o relatório imprime lógica equivalente em outro método (ver PB-08), o que duplica código.

PB-04 — Barra: “Conclusão geral” na tela de detalhe

Onde aparece: rota obras:detalhe_obra (/obras/<id>/), cabeçalho em templates/obras/obra_detail.html (lines 56-63).
Fonte do valor: ObraDetailView.get_context_data (obras/views.py (lines 480-503)).
Base de cálculo: percentual_concluido = round((tarefas_concluidas / total_tarefas) * 100, 1); não usa médias parciais.
Dependências: Tarefa.status.
Observações: ignora tarefas parcialmente concluídas, por isso pode ficar “travado” até a conclusão total; não reutiliza _clamp_percentage, embora o valor já esteja naturalmente em 0..100.

PB-05 — Barra: Progresso de cada categoria no detalhe

Onde aparece: mesma rota /obras/<id>/, accordion em templates/obras/obra_detail.html (lines 350-357).
Fonte do valor: property Categoria.percentual_concluido (obras/models.py (lines 64-69)).
Base de cálculo: média (Avg) dos campos Tarefa.percentual_concluido da categoria, arredondada para uma casa; retorna 0 se não houver tarefas.
Dependências: Tarefa.percentual_concluido (campo PositiveIntegerField validado entre 0 e 100 em obras/models.py (lines 96-133)).
Observações: cada acesso à property dispara um aggregate, então o template (barra + texto) já gera duas consultas por categoria; o AJAX que retorna new_category_progress em update_task_progress (obras/views.py:359-402) aciona outro aggregate, caracterizando N+1.

PB-06 — Indicador: badge editável de progresso da tarefa

Onde aparece: rota /obras/<id>/, badges .task-progress em templates/obras/obra_detail.html (lines 366-387).
Fonte do valor: campo Tarefa.percentual_concluido e o endpoint update_task_progress (obras/views.py (lines 359-402)) acionado pelo script static/js/obras.js (lines 19-125).
Base de cálculo: valor persistido pelo usuário (slider 0–100), validado no backend (if not (0 <= progress <= 100)).
Dependências: Tarefa.percentual_concluido, Categoria.percentual_concluido (retornado após a atualização), Tarefa.status (para bloqueios).
Observações: o cálculo não acontece no template, mas o indicador mostra valores brutos do banco; como cada atualização recalcula categoria.percentual_concluido, mantém o mesmo problema de N+1 e pode gerar latência em mass updates.

PB-07 — Barra: “Progresso real” no relatório da obra

Onde aparece: rota obras:relatorio_obra (/obras/<id>/relatorio/), cards em templates/obras/relatorio_obra.html (lines 74-82).
Fonte do valor: ObraReportView.get_context_data (obras/views.py (lines 553-565)).
Base de cálculo: idêntico ao PB-04 (concluidas/total * 100, arredondado).
Dependências: Tarefa.status.
Observações: novamente ignora progresso parcial; repete a mesma lógica da tela de detalhes em vez de reaproveitar um serviço comum.

PB-08 — Barra: “Progresso esperado” no relatório

Onde aparece: templates/obras/relatorio_obra.html (lines 84-97).
Fonte do valor: método privado _calc_progresso_esperado em ObraReportView (obras/views.py (lines 605-614)).
Base de cálculo: (dias_passados / total_dias) * 100 clamped e arredondado; se total_dias <= 0, retorna 100 ou 0 conforme a data atual.
Dependências: Obra.data_inicio, Obra.data_fim_prevista.
Observações: duplica a lógica de calculate_expected_progress (PB-03) com pequenas diferenças (usa timezone.now() direto e não aceita reference_date), mantendo duas “fontes” para o mesmo conceito.

PB-09 — Barra: Progresso por categoria no relatório

Onde aparece: templates/obras/relatorio_obra.html (lines 223-228).
Fonte do valor: mesma property Categoria.percentual_concluido (obras/models.py (lines 64-69)).
Base de cálculo / Dependências: iguais ao PB-05.
Observações: sofre do mesmo N+1; como o relatório costuma listar todas as categorias de uma vez, o impacto é maior (cada categoria faz duas consultas para barra + texto, vezes o número de categorias).

PB-10 — Barra: Progresso por tarefa no relatório

Onde aparece: templates/obras/relatorio_obra.html (lines 257-261).
Fonte do valor: campo Tarefa.percentual_concluido renderizado diretamente.
Base de cálculo: valor persistido/validado via formulários ou update_task_progress (ver PB-06).
Dependências: tabela Tarefa.
Observações: exibe o dado bruto sem clamp adicional; como os valores já passam pela validação MinValueValidator/MaxValueValidator, o risco de sair de 0..100 é baixo, mas se algum dado legado fugir desse range não há proteção visual.